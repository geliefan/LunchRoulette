# Lunch Roulette 起動手順

## 概要

このドキュメントは、Lunch Rouletteアプリケーションをローカル環境およびGitHub Codespacesで起動するための手順を説明します。

## 前提条件

### 必須

- WeatherAPI.com APIキー
- Hot Pepper Gourmet APIキー

### ローカル環境の場合

- Python 3.11以上
- pip（Pythonパッケージマネージャー）
- Git

### GitHub Codespacesの場合

- GitHubアカウント
- 対象リポジトリへのアクセス権

---

## 1. ローカル環境での起動手順

### 1.1 リポジトリのクローン

```bash
git clone <repository-url>
cd lunch-roulette
```

### 1.2 仮想環境の作成と有効化

```bash
# 仮想環境の作成
python -m venv .venv

# 有効化（Linux/macOS）
source .venv/bin/activate

# 有効化（Windows コマンドプロンプト）
.venv\Scripts\activate

# 有効化（Windows PowerShell）
.venv\Scripts\Activate.ps1
```

### 1.3 依存関係のインストール

```bash
# 本番用依存関係のみ
pip install -r requirements.txt

# 開発用依存関係も含める場合
pip install -r requirements-dev.txt
```

### 1.4 環境変数の設定

`.env.example`をコピーして`.env`ファイルを作成し、APIキーを設定します。

```bash
cp .env.example .env
```

`.env`ファイルを編集して、以下の必須項目を設定:

```dotenv
# 必須: APIキー
WEATHERAPI_KEY=your_weatherapi_key_here
HOTPEPPER_API_KEY=your_hotpepper_api_key_here

# オプション: 開発環境ではデバッグモードを有効化
FLASK_DEBUG=true

# オプション: ローカル環境用のデータベースパス
DATABASE_PATH=cache.db
```

### 1.5 データベースの初期化

```bash
python -c "from src.lunch_roulette.models.database import init_database; init_database('cache.db')"
```

### 1.6 アプリケーションの起動

```bash
python run.py
```

### 1.7 ブラウザでアクセス

[http://localhost:5000](http://localhost:5000) にアクセスしてアプリケーションを確認します。

---

## 2. GitHub Codespacesでの起動手順

### 2.1 Codespaceの作成

1. GitHubでリポジトリページを開く
2. 緑色の「Code」ボタンをクリック
3. 「Codespaces」タブを選択
4. 「Create codespace on main」をクリック（または既存のCodespaceを選択）

Codespaceが起動し、VS Codeがブラウザで開きます。

### 2.2 環境変数の設定

Codespaceのターミナルで以下を実行:

```bash
cp .env.example .env
```

`.env`ファイルを編集して、APIキーを設定します:

```dotenv
# 必須: APIキー
WEATHERAPI_KEY=your_weatherapi_key_here
HOTPEPPER_API_KEY=your_hotpepper_api_key_here

# 開発環境設定
FLASK_DEBUG=true
DATABASE_PATH=cache.db
HOST=0.0.0.0
```

**注意**: `HOST=0.0.0.0`を設定することで、Codespacesのポートフォワーディングが正しく動作します。

### 2.3 依存関係のインストール

```bash
# 仮想環境の作成と有効化
python -m venv .venv
source .venv/bin/activate

# 依存関係のインストール
pip install -r requirements-dev.txt
```

### 2.4 データベースの初期化

```bash
python -c "from src.lunch_roulette.models.database import init_database; init_database('cache.db')"
```

### 2.5 アプリケーションの起動

```bash
python run.py
```

### 2.6 ブラウザでアクセス

1. ターミナルに表示されるポートフォワーディングの通知をクリック
2. または、VS Codeの「PORTS」タブでポート5000の「Open in Browser」をクリック
3. ポートの公開範囲を「Public」に変更すると、他のユーザーとも共有可能

---

## 3. 環境変数リファレンス

### 3.1 必須環境変数

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `WEATHERAPI_KEY` | WeatherAPI.com APIキー | `abc123xyz` |
| `HOTPEPPER_API_KEY` | Hot Pepper Gourmet APIキー | `xyz789abc` |

### 3.2 オプション環境変数

| 変数名 | 説明 | デフォルト値 |
|--------|------|------------|
| `SECRET_KEY` | Flaskセッション暗号化キー | `dev-secret-key-change-in-production` |
| `FLASK_DEBUG` | デバッグモード | `false` |
| `HOST` | サーバーバインドアドレス | `127.0.0.1` |
| `PORT` | サーバーポート | `5000` |
| `DATABASE_PATH` | SQLiteキャッシュDBパス | `cache.db` |
| `CACHE_TTL_MINUTES` | キャッシュ有効期限（分） | `10` |
| `DEFAULT_LATITUDE` | デフォルト緯度（東京駅） | `35.6812` |
| `DEFAULT_LONGITUDE` | デフォルト経度（東京駅） | `139.7671` |
| `SEARCH_RADIUS_KM` | レストラン検索半径（km） | `1.0` |
| `MAX_BUDGET_YEN` | 最大予算（円） | `1200` |
| `DEFAULT_MAX_WALKING_TIME_MIN` | デフォルト最大徒歩時間（分） | `10` |

---

## 4. APIキーの取得方法

### 4.1 WeatherAPI.com APIキー

1. [WeatherAPI.com](https://www.weatherapi.com/) にアクセス
2. 「Sign Up」でアカウント作成
3. ダッシュボードでAPIキーを確認
4. 無料プランで月100万リクエストまで利用可能

### 4.2 Hot Pepper Gourmet APIキー

1. [リクルートWebサービス](https://webservice.recruit.co.jp/) にアクセス
2. アカウント作成・ログイン
3. 「Hot Pepper グルメサーチAPI」のAPIキーを取得
4. 無料プランで1日3,000リクエストまで利用可能

---

## 5. 動作確認チェックリスト

- [ ] アプリケーションが起動している
- [ ] ブラウザでページが正常に表示される
- [ ] 位置情報が表示される（デフォルト: 東京駅）
- [ ] 天気情報が表示される
- [ ] ルーレットボタンが動作する
- [ ] レストラン情報が表示される

---

## 6. トラブルシューティング

### 6.1 よくある問題と解決方法

#### 問題: APIキーエラー

```
エラー: Invalid API key
```

**解決方法:**
- `.env`ファイルが正しく作成されているか確認
- APIキーに余分なスペースや改行が含まれていないか確認
- APIキーが有効であることを各サービスのダッシュボードで確認

#### 問題: データベース接続エラー

```
エラー: database is locked
```

**解決方法:**
- アプリケーションを再起動
- `cache.db`ファイルを削除して再初期化

```bash
rm cache.db
python -c "from src.lunch_roulette.models.database import init_database; init_database('cache.db')"
```

#### 問題: モジュールが見つからない

```
エラー: ModuleNotFoundError: No module named 'lunch_roulette'
```

**解決方法:**
- 仮想環境が有効化されているか確認
- プロジェクトルートディレクトリで実行しているか確認
- `pip install -r requirements.txt`を再実行

#### 問題: ポートが使用中

```
エラー: Address already in use
```

**解決方法:**
- 別のポートを使用: `PORT=5001 python run.py`
- 既存のプロセスを終了: `lsof -i :5000` で確認し、`kill <PID>`

#### 問題: Codespacesでページにアクセスできない

**解決方法:**
- `.env`に`HOST=0.0.0.0`が設定されているか確認
- VS Codeの「PORTS」タブでポート5000が表示されているか確認
- ポートの公開範囲が適切に設定されているか確認

---

## 7. テスト実行

### 7.1 単体テスト

```bash
source .venv/bin/activate
PYTHONPATH=. pytest
```

### 7.2 カバレッジレポート付きテスト

```bash
PYTHONPATH=. pytest --cov=src --cov-report=html
```

### 7.3 リンティング

```bash
flake8 src/
```

---

## 8. 関連リンク

- [Flask Documentation](https://flask.palletsprojects.com/)
- [WeatherAPI.com Documentation](https://www.weatherapi.com/docs/)
- [Hot Pepper Gourmet API](https://webservice.recruit.co.jp/doc/hotpepper/)
- [GitHub Codespaces Documentation](https://docs.github.com/en/codespaces)

---

## 9. プロジェクト情報

- **技術スタック**: Python 3.11, Flask 3.x, SQLite
- **外部API**: WeatherAPI.com, Hot Pepper Gourmet Search API, ipapi.co
- **対応環境**: ローカル開発環境, GitHub Codespaces